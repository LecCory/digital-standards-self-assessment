parameters:
  faName: ""
  apiURL: ""
  rgName: ""
  apiGWName: ""
  azureSubscription: ""

steps:
  - task: CmdLine@2
    displayName: Build OpenAPI file
    env:
      FANAME: ${{ parameters.faName }}
      APIURL: ${{ parameters.apiURL }}
    inputs:
      script: |
        node fixSwagger.js
        node fixAPIMPolicy.js
      workingDirectory: "$(Build.SourcesDirectory)/infrastructure/helperScripts"

  - task: AzureCLI@2
    displayName: Import OpenAPI file into APIM
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "ps"
      scriptLocation: "inlineScript"
      inlineScript: |
        az apim api import -g ${{ parameters.rgName }} --service-name ${{ parameters.apiGWName }} --path api --specification-path ./swagger.json --specification-format OpenApiJson --api-id ${{ parameters.faName }} --subscription-required false
       
      workingDirectory: "$(Build.SourcesDirectory)\infrastructure"
  
  - task: AzurePowerShell@5
    displayName: Import APIM policy
    inputs:
      azureSubscription: 'Azure subscription 1 (1ff6c602-69fe-454f-a795-de22a178a6c0)'
      ScriptType: 'InlineScript'
      Inline: |
        Install-Module Az.ApiManagement -Scope CurrentUser -Force
        Import-Module Az.ApiManagement -Force
        
        $apimContext = New-AzApiManagementContext -ResourceGroupName ${{ parameters.rgName }} -ServiceName ${{ parameters.apiGWName }}
                Set-AzApiManagementPolicy -Context $apimContext -ApiId ${{ parameters.faName }} -PolicyFilePath "./newPolicy.xml"
      errorActionPreference: 'continue'
      azurePowerShellVersion: 'LatestVersion'
      workingDirectory: '$(Build.SourcesDirectory)\infrastructure'
